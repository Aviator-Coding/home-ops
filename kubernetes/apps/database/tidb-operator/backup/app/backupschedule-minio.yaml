---
apiVersion: br.pingcap.com/v1alpha1
kind: BackupSchedule
metadata:
  name: tidb-backup-minio
spec:
  # 4x daily backups at offset hours to avoid IOPS spikes
  schedule: "0 3,9,15,21 * * *"
  maxBackups: 8  # Keep 8 backups (reduced from 24)
  maxReservedTime: "168h"  # 7 days maximum retention

  backupTemplate:
    # BR tool configuration
    br:
      cluster: homelab-kvstore
      # Concurrency for backup operations (defaults to 4)
      concurrency: 4
      # Use checksum to verify backup integrity
      checksum: true

    # MinIO S3 configuration
    s3:
      provider: minio
      secretName: tidb-backup-minio-secret
      bucket: tidb-backups
      prefix: hourly/homelab-kvstore
      # CRITICAL: MinIO requires path-style URLs
      endpoint: "http://nas.${SECRET_DOMAIN}:9000"
      options:
        - --s3.force-path-style=true

    # Resource limits for backup pods
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        memory: 4Gi

    # Cleanup policy
    cleanPolicy: Delete
