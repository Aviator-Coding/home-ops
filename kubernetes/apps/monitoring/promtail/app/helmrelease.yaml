---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: promtail
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: promtail
  values:
    fullnameOverride: promtail

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 256Mi

    config:
      clients:
        - url: http://loki-headless.monitoring.svc.cluster.local:3100/loki/api/v1/push
          tenant_id: ""
          batchwait: 1s
          batchsize: 1048576
          timeout: 10s
          backoff_config:
            min_period: 500ms
            max_period: 5m
            max_retries: 10

      snippets:
        # Add relabel configs to properly label Ceph logs for dashboard compatibility
        extraRelabelConfigs:
          # Add ceph_daemon_type label for Ceph dashboard compatibility
          - source_labels: [__meta_kubernetes_pod_label_ceph_daemon_type]
            target_label: ceph_daemon_type
          # Add ceph_daemon_id label
          - source_labels: [__meta_kubernetes_pod_label_ceph_daemon_id]
            target_label: ceph_daemon_id
          # Add ceph_cluster_id label
          - source_labels: [__meta_kubernetes_namespace]
            regex: rook-ceph
            target_label: ceph_cluster_id
            replacement: rook-ceph
          # Add hostname label
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: hostname
          # Identify log type based on container
          - source_labels: [__meta_kubernetes_container_name]
            regex: "(mgr|mon|osd|mds|rgw)"
            target_label: log_type
            replacement: daemon

    serviceMonitor:
      enabled: true
