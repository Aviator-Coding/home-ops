---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dify
  namespace: dify
spec:
  interval: 30m
  chart:
    spec:
      chart: dify
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: dify
        namespace: flux-system
      interval: 12h

  install:
    crds: Create
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  timeout: 20m

  valuesFrom:
    - kind: Secret
      name: dify-secret
      valuesKey: SECRET_DIFY_APP_SECRET_KEY
      targetPath: global.appSecretKey
    - kind: Secret
      name: dify-secret
      valuesKey: SECRET_DIFY_INNER_API_KEY
      targetPath: global.innerApiKey
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_HOST
      targetPath: externalPostgres.address
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_PORT
      targetPath: externalPostgres.port
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_NAME
      targetPath: externalPostgres.credentials.dify.username
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_PASSWORD
      targetPath: externalPostgres.credentials.dify.password
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_NAME
      targetPath: externalPostgres.credentials.dify.database
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_NAME
      targetPath: externalPostgres.credentials.enterprise.username
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_PASSWORD
      targetPath: externalPostgres.credentials.enterprise.password
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_NAME
      targetPath: externalPostgres.credentials.enterprise.database
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_NAME
      targetPath: externalPostgres.credentials.plugin_daemon.username
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_PASSWORD
      targetPath: externalPostgres.credentials.plugin_daemon.password
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_NAME
      targetPath: externalPostgres.credentials.plugin_daemon.database
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_NAME
      targetPath: externalPostgres.credentials.audit.username
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_USER_PASSWORD
      targetPath: externalPostgres.credentials.audit.password
    - kind: Secret
      name: dify-secret
      valuesKey: POSTGRES_DB_NAME
      targetPath: externalPostgres.credentials.audit.database

  values:
    global:
      useTLS: true
      dbMigrationEnabled: true

    externalPostgres:
      enabled: true

    externalRedis:
      enabled: true
      host: dify-dragonfly
      port: 6379
      db: 0
      useSSL: false

    persistence:
      enabled: true
      type: local
      local:
        mountPath: /app/api/storage
        persistentVolumeClaim:
          existingClaim: ""
          storageClass: ceph-filesystem
          accessModes: ReadWriteMany
          size: 10Gi

    api:
      replicas: 2
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi
      extraEnv:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: DATABASE_URL # @todo
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: REDIS_URL # @todo
        - name: UPLOAD_FILE_SIZE_LIMIT
          value: "50"
        - name: RATE_LIMIT_ENABLED
          value: "true"

    worker:
      replicas: 2
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi
      extraEnv:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: DATABASE_URL # @todo
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: REDIS_URL # @todo

    triggerWorker:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      extraEnv:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: DATABASE_URL # @todo
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: REDIS_URL # @todo

    workerBeat:
      enabled: true
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      extraEnv:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: DATABASE_URL # @todo
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: dify-secret
              key: REDIS_URL # @todo

    web:
      replicas: 2
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    sandbox:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi

    plugin_daemon:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi

    ssrfProxy:
      enabled: true
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
    enterprise:
      enabled: false

    enterpriseAudit:
      enabled: false

    gateway:
      enabled: false

    ingress:
      enabled: false
