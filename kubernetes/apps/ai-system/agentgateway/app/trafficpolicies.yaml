---
# Prompt Guards and Security Policy
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: prompt-guards
  namespace: ai-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: llm-routes
  ai:
    promptGuard:
      # Request filtering - block malicious input
      request:
        customResponse:
          message: "Request blocked due to policy violation"
        regex:
          action: Reject
          matches:
            # Block prompt injection attempts
            - pattern: "(?i)ignore.*previous.*instructions"
              name: "prompt-injection-1"
            - pattern: "(?i)you.*are.*now"
              name: "prompt-injection-2"
            - pattern: "(?i)forget.*everything"
              name: "prompt-injection-3"
            - pattern: "(?i)disregard.*all.*prior"
              name: "prompt-injection-4"
            # Block requests for sensitive data
            - pattern: "(?i)(password|api.?key|secret|token).*reveal"
              name: "sensitive-request"
      # Response masking - protect PII
      response:
        regex:
          action: Mask
          builtins:
            - CREDIT_CARD
            - EMAIL
            - PHONE_NUMBER
            - SSN
---
# Rate Limiting Policy
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: rate-limiting
  namespace: ai-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: agentgateway
  rateLimit:
    local:
      tokenBucket:
        maxTokens: 100
        tokensPerFill: 100
        fillInterval: 1s
---
# Timeout Policy
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: timeout-policy
  namespace: ai-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: llm-routes
  timeouts:
    request: 60s
    streamIdle: 300s
---
# Backend Traffic Policy for connection settings
apiVersion: gateway.kgateway.dev/v1alpha1
kind: BackendConfigPolicy
metadata:
  name: backend-config
  namespace: ai-system
spec:
  targetRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: openai
    - group: gateway.kgateway.dev
      kind: Backend
      name: anthropic
    - group: gateway.kgateway.dev
      kind: Backend
      name: gemini
    - group: gateway.kgateway.dev
      kind: Backend
      name: groq
    - group: gateway.kgateway.dev
      kind: Backend
      name: deepseek
    - group: gateway.kgateway.dev
      kind: Backend
      name: xai
    - group: gateway.kgateway.dev
      kind: Backend
      name: mistral
    - group: gateway.kgateway.dev
      kind: Backend
      name: togetherai
  connectTimeout: 10s
  commonHttpProtocolOptions:
    maxRequestsPerConnection: 1000
